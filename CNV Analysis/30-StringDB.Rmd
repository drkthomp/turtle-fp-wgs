---
title: "StringDB Analysis"
params: 
    type: "within"
    bp: 5000
    minReadCount: 4
    normType: "poisson"
    sizeFactor: "mean"
---
Run on `r date()` with `r params$bp`bp size windows, `r params$normType` normalized with the `r params$sizeFactor` size factor. A minimum of `r params$minReadCount` CNVs were required for a segment to be recorded. Gene annotations were done as `r params$type` with the segment. 
```{r Load Relevant Libraries}
library(STRINGdb)
library(tidyverse)
library(Biostrings)
library(GenomicFeatures)
library(UpSetR)
library("chroma")
library(janitor)
library(knitr)
theme_set(theme_minimal())
```

```{r Load Basic Data}

load("partials/sample_data") 
annoloc <- paste("02-Annotation", params$type, params$bp, params$normType, sep="/")
saveloc <- paste("03-StringDB", params$type, params$bp, params$normType, sep="/")

partialsloc <- paste0("partials/stringdb/",params$type,params$bp, params$normType, params$sizeFactor, params$minReadCount)
  string_db <- STRINGdb$new( version="11", species=9606,score_threshold=150, input_directory="03-StringDB/")
reuse <- TRUE
```


## Get Gene Annotations
This notebook assumes that files generated by previous Rmarkdown files are present at `r annoloc`, otherwise this will throw errors. 
```{r Get Descriptions}

getDescriptions <- function(x){
  filename <- paste0(annoloc,"/", x)
  description <- NULL
  out <- tryCatch(
    {
      description <- read.csv(filename, header=FALSE, sep=";")
      names(description) <- "genes"
    },
    error=function(cond) {
      message(paste("\nFile does not seem to be valid:", x))
      message("Here's the original error message:")
      message(cond)
      # Choose a return value in case of error
      return(NULL)
    },
    warning=function(cond) {
      message(paste("File caused a warning:", x))
      message("Here's the original warning message:")
      message(cond)
    }
  )
  return(description)
}

# get the filenames and actual anmes

descriptions_file <- paste0(partialsloc, "_descriptions.gz")
if(reuse && file.exists(descriptions_file)){
  load(descriptions_file)
  names <- names(descriptions)
} else {
file_list <- list.files(path=annoloc, pattern=glob2rx(pattern = paste0(params$sizeFactor, "-", params$minReadCount, "-*_raw_descriptions.txt")))
names <- str_remove_all(file_list, "raw_descriptions|txt|cnvs|FILTERED|_|\\.")
descriptions <- lapply(file_list, getDescriptions)
names(descriptions) <- names
save(descriptions,file=descriptions_file)
}
```

## StringDB Mapping 

```{r StringDB Mapping}
peformString <- function(x){
  if(is_null(descriptions[[x]])){ # guard against NULL
    return(NULL)
  }
  if(reuse & file.exists(paste0(saveloc,"/",x,".gz"))){
    message(paste("File found for STRING on", x))
    load(paste0(saveloc,"/",x,".gz"))
    #genes <- multi_map_df(map, string_db$get_aliases(), "STRING_id", "STRING_id", "alias")
  }
  else {
    message(paste("Running STRING on", x))
    map <- multi_map_df(descriptions[[x]], string_db$get_aliases(), "genes",
                        "alias", "STRING_id",caseSensitive=FALSE)
    #genes <- multi_map_df(map, string_db$get_aliases(), "STRING_id","STRING_id", "alias")
    naDf = subset(map, is.na(STRING_id))
    if (nrow(naDf) > 0){
      cat(paste("Warning:  we couldn't map to STRING ", as.integer((nrow(naDf)/nrow(map)) *
                                                                     100), "% of your identifiers: ", sep = ""))
      cat(paste(head(naDf)$genes, sep=", "))
    }
    
    save(map, file=paste0(saveloc,"/",x,".gz"),compress=TRUE)
  }
  if(reuse & file.exists(paste0(saveloc,"/",x,".pdf"))){
    message("Graph already exists.")
  }
  else{
    message(paste("Saving to", paste0(saveloc,"/",x,".pdf")))
    
    pdf(file=paste0(saveloc,"/",x,".pdf"),width = 20,height=18)
    tryCatch(string_db$plot_network(map$STRING_id), error=function(cond){
      # this likely happends if there's no valid STRING_ids 
      # (ie, coulding map to STRING 100% of your identifiers)
      message(paste("Couldn't plot network of", count(map), "genes."))
      message(cond)
    })
    dev.off()
   
  }
  return(map)
}

mappings_file <- paste0(partialsloc,"_mappings.gz")
if(reuse && file.exists(mappings_file)){
  load(mappings_file)
} else {
mappings <- lapply(unique(names), peformString)
names(mappings) <- unique(names)
save(mappings, file=mappings_file)
}
```
### StringDB Plots
```{bash eval=FALSE, engine.path="/bin/bash", include=FALSE}
pwd
cd within/
mogrify -verbose -density 500 -resize 800 -format png ./*.pdf
```

## StringDB Enrichment 
```{r Retrieve Enrichments}
options(timeout=600) # if we're downloading stringdb, we need a longer time out 
getMegaEnrichment <- function(x){
  return(string_db$get_enrichment(bind_rows(mappings)$STRING_id) %>% arrange(p_value))
}
enrichments_file <- paste0(partialsloc, "_enrichments.gz")
if(reuse && file.exists(enrichments_file)){
  load(enrichments_file) # load the enrichment file if relevant 
} else {
enrichments <- lapply(mappings, function(x){
  if(length(x$STRING_id %>% na.omit()) > 0) { # guard against empty mappings
     enrich <- string_db$get_enrichment( x$STRING_id ) %>% arrange(p_value)
     if(count(enrich) > 0){ # and empty enrichments 
       return(enrich)
     }
}
  return(NA)
}) # otherwise get the enrichment information 
# and remove any NAs 
save(enrichments,file=enrichments_file) # and save it for the future 
}
```

### Enrichment Plots 
```{r UpSetR Settings}
colors_edge <- as.vector(c("#e41a1c", rep("#377eb8",2), "#4daf4a", "#984ea3","#c36100", "#c47800", "#c38e00", rep("#bfa407", 3), "#b9b925"))
colors_fill <- alpha(lighten(colors_edge,amount=2))
sets <- rev(names)
metadata <- as.data.frame(cbind(sets, colors=sets))
```
```{r Enrichment Term Overlap}
enrich_terms <- lapply(enrichments, function(x){
  if(is.na(x)){
    return(x)
  }
  x <- x %>% filter(p_value < 0.05)
  return(x$term)})
names(enrich_terms) <- names # maintain the names 
# quick look at the overlap between the samples  
upset(fromList(enrich_terms), order.by = "degree",mb.ratio = c(0.4, 0.6),mainbar.y.label = "Signifigant terms", nintersects = NA, sets.x.label = "Signifigant terms per Sample",sets=rev(names),keep.order = TRUE,sets.bar.color = rev(colors_edge), set.metadata = list(data = metadata, plots = list(list(type = "matrix_rows", 
    column = "colors", colors = setNames(colors_edge, names), 
    alpha = 1))))
```


```{r Tidy Enrichment Data}
mega_enrich <- getMegaEnrichment(mappings)
all_enrichments <- bind_rows(enrichments[!is.na(enrichments)],.id="sample") %>% group_by(sample)%>% arrange(p_value) %>% filter(p_value < 0.05) %>% mutate(sample_short = str_trunc(sample,4))

enrichment_stats <- all_enrichments %>% group_by(term) %>% summarize(count = n(), mean_p=mean(p_value),min_p=min(p_value),mean_gene=mean(number_of_genes),sum_gene=sum(number_of_genes)) 

all_enrichments <- all_enrichments %>% left_join(enrichment_stats) %>% distinct()
all_enrichments <- all_enrichments %>% left_join(sample_data,by=c("sample"="sample_name")) %>% distinct()
```
Now we can look at the most relevant enrichments. 
```{r}
relevant <- fromList(enrich_terms) %>% mutate(enrich=unique(unlist(enrich_terms))) %>%
  mutate(all_yu = purrr::reduce(dplyr::select(., starts_with("yu")), `+`)) %>%
  dplyr::select(-starts_with("yu")) %>% mutate(all_yu = case_when(all_yu > 0 ~ 1, TRUE ~ 0)) %>% 
  adorn_totals(where="col") %>% arrange(-Total)%>%
  left_join(enrichments[!is.na(enrichments)] %>% purrr::reduce(bind_rows) %>% dplyr::select(term, description), by =c("enrich" = "term")) %>% 
  distinct() 

relevant %>% filter(Total > 1)
```

```{r}
all_enrichments <- all_enrichments %>% mutate(description = case_when(term == "PMID.32235722" ~ "(2020) T-Cells in Lymphoid Stress Surveillance", TRUE ~ description ))

ggplot(all_enrichments %>% filter(term %in% (relevant %>% filter(Total > 1))$enrich),aes(y=reorder(description,-count),x=number_of_genes)) + geom_col(aes(fill=sample,color=sample)) + scale_fill_manual(values=setNames(colors_fill, names)) + scale_color_manual(values=setNames(colors_edge, names)) + labs(title="Common Enrichment Terms",y="Shared Terms between Turtles",x="Number of Genes") + xlim(c(0,40))

+ theme(axis.text.x=element_text(angle=50,vjust=1,hjust=1))

ggplot(all_enrichments %>% filter(term %in% (relevant %>% filter(Total > 1))$enrich),aes(y=reorder(description,count),x=p_value)) + geom_boxplot() +  geom_point(aes(fill=sample,color=sample)) + scale_fill_manual(values=setNames(colors_fill, names)) + scale_color_manual(values=setNames(colors_edge, names)) + labs(title="Common Enrichment Terms",y="Shared Terms between Turtles",x="P-value") + xlim(c(0,0.01))
```

```{r}
ggplot(all_enrichments %>% filter(term %in% head(enrichment_stats %>% arrange(mean_p),n=50)$term),aes(x=reorder(term,-mean_p),y=number_of_genes)) + geom_col() + labs(title="Common Enrichment Terms",x="Top 50 Enrichments by Mean P-Value",y="Number of Genes") + ylim(c(0,40)) + facet_grid( turtle.x ~ .,scales="free")+ theme(axis.text.x=element_text(angle=90,vjust=1,hjust=1))

ggplot(all_enrichments %>% filter(term %in% head(enrichment_stats %>% filter(str_trunc(term,width=4,ellipsis="") != "PMID") %>%  arrange(mean_p),n=50)$term),aes(x=reorder(term,-mean_p),y=number_of_genes)) + geom_col() + labs(title="Common Enrichment Terms",x="Top 50 Enrichments by Mean P-Value",y="Number of Genes") +  facet_grid( turtle.x ~ .)+ theme(axis.text.x=element_text(angle=90,vjust=1,hjust=1))

ggplot(all_enrichments %>% filter(term %in% (relevant %>% filter(Total > 1))$enrich),aes(y=reorder(description,count),x=p_value)) + geom_boxplot() +  geom_point(aes(fill=sample,color=sample)) + scale_fill_manual(values=setNames(colors_fill, names)) + scale_color_manual(values=setNames(colors_edge, names)) + labs(title="Common Enrichment Terms",y="Shared Terms between Turtles",x="P-value") + xlim(c(0,0.01))
```


#### HSA-1280218
```{r}
rel_row <- relevant[relevant$enrich == "HSA-1280218",]
enrich_common <- all_enrichments %>% filter(term == rel_row$enrich)
ggplot(enrich_common, aes(x=sample, y=number_of_genes,fill=sample)) + geom_col() + scale_fill_manual(values=setNames(colors_edge, names)[enrich_common$sample]) +  theme(legend.position = "none",panel.grid.major.x=element_blank()) + labs(title=paste(rel_row$enrich, "-", rel_row$description),x="",y="Number of Genes in Sample") 

enrich_common %>% dplyr::select(sample,preferredNames,p_value)
```
#### SM00589 
```{r}
rel_row <- relevant[relevant$enrich == "SM00589",]
enrich_common <- all_enrichments %>% filter(term == rel_row$enrich)
ggplot(enrich_common, aes(x=sample, y=number_of_genes,fill=sample)) + geom_col() + scale_fill_manual(values=setNames(colors_edge, names)[enrich_common$sample]) +  theme(legend.position = "none",panel.grid.major.x=element_blank()) + labs(title=paste(rel_row$enrich, "-", rel_row$description),x="",y="Number of Genes in Sample") 

enrich_common %>% dplyr::select(sample,preferredNames,p_value)
```
#### SM00449
```{r}
rel_row <- relevant[relevant$enrich == "SM00449",]
enrich_common <- all_enrichments %>% filter(term == rel_row$enrich)
ggplot(enrich_common, aes(x=sample, y=number_of_genes,fill=sample)) + geom_col() + scale_fill_manual(values=setNames(colors_edge, names)[enrich_common$sample]) +  theme(legend.position = "none",panel.grid.major.x=element_blank()) + labs(title=paste(rel_row$enrich, "-", rel_row$description),x="",y="Number of Genes in Sample") 

enrich_common %>% dplyr::select(sample,preferredNames,p_value)
```

#### PF13765
```{r}
rel_row <- relevant[relevant$enrich == "PF13765",]
enrich_common <- all_enrichments %>% filter(term == rel_row$enrich)
ggplot(enrich_common, aes(x=sample, y=number_of_genes,fill=sample)) + geom_col() + scale_fill_manual(values=setNames(colors_edge, names)[enrich_common$sample]) +  theme(legend.position = "none",panel.grid.major.x=element_blank()) + labs(title=paste(rel_row$enrich, "-", rel_row$description),x="",y="Number of Genes in Sample") 

enrich_common %>% dplyr::select(sample,preferredNames,p_value)
```

#### PMID.32235722
```{r}
rel_row <- relevant[relevant$enrich == "PMID.32235722",]
enrich_common <- all_enrichments %>% filter(term == rel_row$enrich)
ggplot(enrich_common, aes(x=sample, y=number_of_genes,fill=sample)) + geom_col() + scale_fill_manual(values=setNames(colors_edge, names)[enrich_common$sample]) +  theme(legend.position = "none",panel.grid.major.x=element_blank()) + labs(title=paste(rel_row$enrich, "-", rel_row$description),x="",y="Number of Genes in Sample") 

enrich_common %>% dplyr::select(sample,preferredNames,p_value)
```


## Euler Plots
Doing a euler or venn for all 12 samples is too much to accurately represent, but we can group them instead: 

### Group by Turtle 

```{r}
library(eulerr)
genes_by_turtle <- list(`27L`=enrich_terms$`27L1Fdna`, Flower=unique(c(enrich_terms$flSCEYfdna, enrich_terms$flSCINFdna)), Poppy=enrich_terms$poSCTFdna, Aladar=enrich_terms$`TABT-Cm`, Yucca=unique(c(enrich_terms$yuLIRSFdna, enrich_terms$yuRERFdna, enrich_terms$yuRIRSFdna, enrich_terms$yuRKTGFdna, enrich_terms$yuRKTMFdna, enrich_terms$yuRKTW1Fdna, enrich_terms$yuTSFdna)))
fit <- euler(genes_by_turtle,shape="ellipse")
plot(fit,fills=unique(colors_fill)[1:length(genes_by_turtle)],adjust_labels=TRUE,quantities=TRUE, legend=TRUE)

upset(fromList(genes_by_turtle), order.by = "degree",mb.ratio = c(0.4, 0.6),mainbar.y.label = "Signifigant terms", nintersects = NA, sets.x.label = "Signifigant terms per Turtle")
head(fromList(genes_by_turtle) %>% mutate(region=unique(unlist(genes_by_turtle))) %>%  adorn_totals(where="col") %>% arrange(-Total) %>% filter(Total > 1),40) %>% dplyr::select(region)
```
```{r}
genes_by_tissue <- list(Lung=unique(c(enrich_terms$`27L1Fdna`,enrich_terms$`TABT-Cm`)), Eye=unique(c(enrich_terms$flSCEYfdna,enrich_terms$yuRERFdna)), Inguinal=unique(c(enrich_terms$flSCINFdna,enrich_terms$yuLIRSFdna, enrich_terms$yuRIRSFdna)), Tail=unique(c(enrich_terms$poSCTFdna,enrich_terms$yuTSFdna)),Kidney=unique(c(enrich_terms$yuRKTGFdna, enrich_terms$yuRKTMFdna, enrich_terms$yuRKTW1Fdna)))
fit <- euler(genes_by_tissue,shape="ellipse")
plot(fit,adjust_labels=TRUE,quantities=TRUE, legend=TRUE)

upset(fromList(genes_by_tissue), order.by = "degree",mb.ratio = c(0.4, 0.6),mainbar.y.label = "Signifigant terms", nintersects = NA, sets.x.label = "Signifigant terms per Tissue")
head(fromList(genes_by_tissue) %>% mutate(region=unique(unlist(genes_by_tissue))) %>%  adorn_totals(where="col") %>% arrange(-Total) %>% filter(Total > 1),40) %>% dplyr::select(region, Total)
```

```{r}
genes_by_src <- list( External=unique(c(enrich_terms$flSCEYfdna,enrich_terms$yuRERFdna,enrich_terms$flSCINFdna,enrich_terms$yuLIRSFdna, enrich_terms$yuRIRSFdna,enrich_terms$poSCTFdna,enrich_terms$yuTSFdna)),Internal=unique(c(enrich_terms$yuRKTGFdna, enrich_terms$yuRKTMFdna, enrich_terms$yuRKTW1Fdna,enrich_terms$`27L1Fdna`,enrich_terms$`TABT-Cm`)))
fit <- euler(genes_by_src,shape="ellipse")
plot(fit,adjust_labels=TRUE,quantities=TRUE, legend=TRUE,weights=c(1-(7/12),(1-(5/12))))
```




